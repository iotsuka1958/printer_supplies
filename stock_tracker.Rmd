---
title: "stock_tracker"
output:
  html_document:
    number_sections: true
date: "latest output `r format(Sys.time(), '%Y-%m-%d %H:%M')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(readxl)
```


事業用プリンターの消耗品を管理するためのRプロジェクト。







\newpage
# Basic Data


- いつどの所属がどの型番の消耗品をいくつ消費したか
- いつどの予算でどの型番の消耗品をいくつ補充したか

を記録する。

csvファイルで作成してもいいが、
不特定多数が入力しやすいexcelファイルで作成しておいて、
作業にあたってデータフレームに読み込むことにした。





```{r}
model_levels <- c("lpc3h17", "lpc3k17", "lpc3k17k", "lpc3t37y", "lpc3t37c", "lpc3t37k", "lpc3t37m", "lpc3t38y", "lpc3t38c", "lpc3t38k", "lpc3t38m", "lpc3t38yv", "lpc3t38cv", "lpc3t38kv", "lpc3t38mv", "lpb3t30", "lpb3t32", "lpb3t32v", "ib02ka", "ib02ca", "ib02ma", "ib02ya", "ib02kb", "ib02cb", "ib02mb", "ib02yb", "ic6cl80", "ic6cl80l", "sc9bk15", "sc9c15", "sc9vm15", "sc9y15", "sc9lc15", "sc9vlm15", "sc9gy15", "sc9mb15", "sc9lgy15", "sc9bk70", "sc9c70", "sc9vm70", "sc9y70", "sc9lc70", "sc9vlm70", "sc9gy70", "sc9mb70", "sc9lgy70")

dpt_levels <- c("消耗品係(在庫品)","消耗品係(内田洋行期首納品)", "消耗品係(情報活用支援班)","消耗品係(生涯学習課予算)","消耗品係(科学技術教育)","総務課総務企画班","研修企画部","情報活用支援班","カリキュラム開発部研究開発班","カリキュラム開発部科学技術教育班","学力調査部", "特別支援教育部")

df_base <- readxl::read_excel("stock_tracker.xlsx", sheet = "data")|>
  mutate(date = ymd(date))|>
  mutate(model = factor(model, levels = model_levels)) |> 
  mutate(dpt = factor(dpt, levels = dpt_levels)) |> 
  mutate(across(.cols = ends_with("qty"),
                .fns = ~replace_na(., 0)
                )
         ) |>
  mutate(nendo = year(date) + if_else(month(date) >= 4, 0, -1)) 
```


```{r}
df_base |> 
  DT::datatable(options = list(pageLength=100))
```

<!--
```{r}
old_df_base <- readxl::read_excel("stock_tracker.xlsx", sheet = "data_old")|>
  mutate(date = ymd(date))|>
  mutate(model = fct_inorder(model)) |> 
  mutate(across(.cols = ends_with("qty"),
                .fns = ~replace_na(., 0)
                )
         ) |>
  mutate(nendo = year(date) + if_else(month(date) >= 4, 0, -1)) 
```

読み込んだデータフレームを表示。

```{r}
old_df_base |> 
  DT::datatable(options = list(pageLength=100))
```


-->


\newpage
# aggregation

## 型番ごとの消費数・在庫数

各型番の在庫数を確認。



```{r}
df_base  |>
  group_by(model) |>
  summarise(purchased_qty = sum(purchased_qty),
            used_qty = sum(used_qty),
                        .groups = "drop") |>
  mutate(stock_qty = purchased_qty - used_qty) |> 
  DT::datatable(options = list(pageLength=100))
```

<!--
```{r}
old_df_base  |>
  group_by(model) |>
  summarise(used_qty = sum(used_qty),
            purchased_qty = sum(purchased_qty), .groups = "drop") |>
  mutate(stock_qty = purchased_qty - used_qty) |> 
  DT::datatable(options = list(pageLength=100))
```
\newpage
-->

\newpage
## 各所属のトータル消費数


```{r}
df_base  |> 
  filter(!str_detect(dpt, "消耗品係"))|> 
  group_by(dpt) |> 
  summarise(used_qty = sum(used_qty), .groups = "drop") |> 
  filter(used_qty > 0) |> 
  arrange(desc(dpt)) |>  
  DT::datatable(options = list(pageLength=100))
```

視覚に訴えるとこんな感じ。
カリキュラム開発部研究開発班の消費が突出している。

```{r}
df_base  |> 
  filter(!str_detect(dpt, "消耗品係")) |> 
  select(-5) |> 
  group_by(dpt) |> 
  mutate(total_used_qty = cumsum(used_qty)) |>
  ungroup() |>
  select(1:4, 6, 5) |>  
  ggplot(aes(date, total_used_qty, 
             colour = fct_reorder2(dpt, date, total_used_qty))) +
  geom_line() + geom_point() +
  labs(colour = NULL, x = "日付", y = "消費数")
```







\newpage
## 各所属の型番別消費数


```{r}
df_base  |> 
  filter(!str_detect(dpt, "消耗品係"))|> 
  group_by(dpt, model) |> 
  summarise(used_qty = sum(used_qty), .groups = "drop") |> 
  filter(used_qty > 0) |> 
  arrange(desc(dpt)) |>  
  DT::datatable(options = list(pageLength=100))
```

```{r}
df_base  |> 
  filter(!str_detect(dpt, "消耗品係")) |> 
  select(-5) |> 
  group_by(dpt, model) |> 
  mutate(total_used_qty = cumsum(used_qty)) |>
  ungroup() |>
  select(1:4, 6, 5) |>  
  ggplot(aes(date, total_used_qty, colour = model)) +
  geom_line() + geom_point() +
  facet_grid(model ~ dpt) +
  labs(colour = "トナー型番", x = "日付", y = "消費数")
```

### 改良版

グラフの線の色をトナーのインクの色と揃えてみる。
このほうが直感的にわかりやすい。
色がどぎついから明度・彩度を抑えめにするのは宿題。
色名ではなくて、RGB値もしくはHEXコードを指定すればいい。

```{r}
df_base  |> 
  filter(!str_detect(dpt, "消耗品係")) |> 
  select(-5) |> 
  group_by(dpt, model) |> 
  mutate(total_used_qty = cumsum(used_qty)) |>
  ungroup() |>
  select(1:4, 6, 5) |>  
  ggplot(aes(date, total_used_qty, colour = model)) +
  geom_line() + geom_point() + facet_grid(model ~ dpt) +
  scale_colour_manual(
		values = c("lpb3t30" = "black",
		           "lpc3t37k" = "black",
		           "lpc3t37y" = "yellow",
		           "lpc3t37c" = "cyan",
		           "lpc3t37m" = "magenta")
  ) +
  labs(colour = "トナー型番", x = "日付", y = "消費数")
```


<!--
```{r}
old_df_base  |> 
  filter(!str_detect(dpt, "消耗品係"))|> 
  group_by(dpt, model) |> 
  summarise(used_qty = sum(used_qty), .groups = "drop") |> 
  DT::datatable(options = list(pageLength=100))
```
-->

\newpage
## 各型番の所属ごと消費数


```{r}
df_base  |> 
  filter(!str_detect(dpt, "消耗品係"))|> 
  group_by(model, dpt) |> 
  summarise(used_qty = sum(used_qty), .groups = "drop") |> 
  filter(used_qty > 0) |> 
  arrange(model) |>  
  DT::datatable(options = list(pageLength=100))
```

